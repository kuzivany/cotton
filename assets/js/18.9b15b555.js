(window.webpackJsonp=window.webpackJsonp||[]).push([[18],{374:function(t,a,s){"use strict";s.r(a);var e=s(42),n=Object(e.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"迁移"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#迁移"}},[t._v("#")]),t._v(" 迁移")]),t._v(" "),s("p",[t._v("我们的标语使用 "),s("em",[t._v("database toolkit")]),t._v(" 代替 "),s("em",[t._v("ORM")]),t._v(" 的原因是因为 Cotton 提供的不仅仅是 ORM。我们提供了一组工具，可帮助你管理使用数据库的 Deno 应用程序。我们希望确保你在开发应用程序时无需在多个工具中来回切换。")]),t._v(" "),s("p",[t._v("在本节中，我们将教你如何使用 Cotton 中的迁移功能。")]),t._v(" "),s("h2",{attrs:{id:"什么是迁移"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#什么是迁移"}},[t._v("#")]),t._v(" 什么是迁移？")]),t._v(" "),s("p",[t._v("如果你不知道什么是迁移，可以将其视为数据库的版本控制（例如[Git]（https://git-scm.com））。假设你正在与团队合作。突然，你意识到 "),s("code",[t._v("users")]),t._v(" 表中缺少 "),s("code",[t._v("email")]),t._v(" 列。 此时，你可能会说 "),s("em",[t._v('"好吧，我只需要告诉其他所有人在他们的数据库上运行此 SQL 查询语句，这样代码就可以工作！"')]),t._v(" 对吗？")]),t._v(" "),s("p",[t._v("但问题在于，无论你是开发小型练习项目还是大型企业项目，这种事情会一直发生。这就是为什么你需要考虑使用迁移的原因。当某人想要更改数据库中的某些内容时，他们要做的就是添加新迁移，该迁移将对数据库执行查询。")]),t._v(" "),s("p",[t._v("关于此功能的妙处，在于你不仅可以 "),s("strong",[t._v("使用")]),t._v(" 新的迁移，还可以 "),s("strong",[t._v("回滚")]),t._v(" 到数据库的先前版本。当出现问题时，这对于调试或回滚你的应用程序非常有用。")]),t._v(" "),s("h2",{attrs:{id:"开始入门"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#开始入门"}},[t._v("#")]),t._v(" 开始入门")]),t._v(" "),s("p",[t._v("你需要做的第一件事是安装 Cotton CLI。")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("$ deno install --allow-net --allow-read --allow-write -n cotton https://deno.land/x/cotton@v0.7.2/cli.ts\n")])])]),s("p",[t._v("安装完成后，你可以在终端中键入 "),s("code",[t._v("cotton")]),t._v(" 以验证是否安装成功。")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v('$ cotton\n\nCotton CLI v0.1.0\n\nUsage:\n  cotton [command] [options]\n\n\nOptions:\n  -h, --help\n    Prints help information\n  -c, --config\n    Set the location of your database configuration (default: "ormconfig.json")\n\n\nCommands:\n  migration:create  Creates a new migration file\n  migration:up      Apply all available migrations\n  migration:down    Revert the last "batch" migrations\n  migration:info    Get the status of all migrations\n')])])]),s("p",[t._v("如你所见，我们有一堆命令可用于管理迁移。让我们从创建一个新的迁移文件开始。")]),t._v(" "),s("h2",{attrs:{id:"创建迁移"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#创建迁移"}},[t._v("#")]),t._v(" 创建迁移")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("$ cotton migration:create --name CreateUserTable\n")])])]),s("p",[t._v("这条命令将在当前目录内创建一个包含迁移文件的 "),s("code",[t._v("migrations/")]),t._v(" 文件夹。这些文件中都有其自己的时间戳，可以帮助我们确定这些迁移的正确执行顺序。")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("$ tree migrations\nmigrations\n└── 20200717134438_CreateUserTable.ts\n")])])]),s("p",[t._v("让我们看一下迁移文件中的内容。")]),t._v(" "),s("div",{staticClass:"language-ts extra-class"},[s("pre",{pre:!0,attrs:{class:"language-ts"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" Schema "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"https://deno.land/x/cotton/mod.ts"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("up")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("schema"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Schema"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Do something...")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("down")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("schema"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Schema"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Do something...")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("代码非常简单。 我们有一个 "),s("code",[t._v("up")]),t._v(" 功能来 "),s("strong",[t._v("应用")]),t._v(" 此迁移到数据库，还有一个 "),s("code",[t._v("down")]),t._v(" 功能来 "),s("strong",[t._v("恢复")]),t._v(" 到以前的版本。")]),t._v(" "),s("p",[t._v("要应用现有的迁移，你所要做的就是运行 "),s("code",[t._v("cotton migration：up")]),t._v("。")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("$ cotton migration:up\n\nMigrating: 20200717134438_CreateUserTable\nMigrated:  20200717134438_CreateUserTable\n")])])]),s("p",[t._v("返回数据库的先前版本也超级简单。")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("$ cotton migration:down\n\nReverting: 20200717134438_CreateUserTable\nReverted:  20200717134438_CreateUserTable\n")])])]),s("p",[t._v("默认情况下，将还原到上一个迁移版本，该版本可以包含多个迁移。此外，你还可以通过传递 "),s("code",[t._v("--steps")]),t._v(" 选项来指定要还原的迁移数量。")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("$ cotton migration:down --steps 1\n")])])]),s("h2",{attrs:{id:"迁移日志"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#迁移日志"}},[t._v("#")]),t._v(" 迁移日志")]),t._v(" "),s("p",[t._v("你可以通过 "),s("code",[t._v("migration:info")]),t._v(" 命令查看所有可用的迁移。这将打印出每个迁移，并检查是否已将其应用于数据库。")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("Applied  Migration\n-------  ------------------------------\nYes      20200717134438_CreateUserTable\n")])])])])}),[],!1,null,null,null);a.default=n.exports}}]);